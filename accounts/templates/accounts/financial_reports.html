{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load account_filters %}

{% block title %}Financial Reports{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style>
    .dashboard-header {
        background: #2c3e50;
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .dashboard-header h1 {
        margin: 0;
        font-size: 2.2rem;
        font-weight: 600;
        letter-spacing: 0.5px;
    }
    .dashboard-header .btn-light {
        border: 1px solid rgba(255,255,255,0.2);
        padding: 0.75rem 1.5rem;
        font-weight: 500;
    }
    .dashboard-header .btn-light:hover {
        background: rgba(255,255,255,0.1);
        color: white;
    }
    .container-fluid {
        padding: 0 2rem;
    }
    .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    .card-header {
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        padding: 1rem 1.5rem;
    }
    .card-body {
        padding: 1.5rem;
    }
    .table th {
        font-weight: 600;
        color: #2c3e50;
    }
    .table td {
        vertical-align: middle;
    }
    .text-end {
        text-align: right !important;
    }
    .nav-buttons {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        z-index: 1000;
    }
    .nav-buttons .btn {
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        margin-left: 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .chart-container {
        height: 300px;
        margin-bottom: 2rem;
    }
    .export-buttons {
        margin-bottom: 1rem;
    }
    .comparison-badge {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        margin-left: 0.5rem;
    }
    .comparison-badge.positive {
        background-color: #d4edda;
        color: #155724;
    }
    .comparison-badge.negative {
        background-color: #f8d7da;
        color: #721c24;
    }
    .flatpickr-input {
        background-color: white !important;
    }
    .date-comparison {
        display: none;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #dee2e6;
    }
    .date-comparison.show {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center">
            <h1>Financial Reports</h1>
            <div class="d-flex gap-3">
                <a href="{% url 'accounts:accounting_dashboard' %}" class="btn btn-light">
                    <i class="fas fa-chart-line me-2"></i>Accounting Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <!-- Date Filter -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <label for="start_date" class="form-label">Start Date</label>
                    <input type="text" class="form-control datepicker" id="start_date" name="start_date" value="{{ start_date|date:'d/m/Y' }}">
                </div>
                <div class="col-md-4">
                    <label for="end_date" class="form-label">End Date</label>
                    <input type="text" class="form-control datepicker" id="end_date" name="end_date" value="{{ end_date|date:'d/m/Y' }}">
                </div>
                <div class="col-md-4 d-flex align-items-end gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter me-2"></i>Apply Filter
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="compareToggle">
                        <i class="fas fa-exchange-alt me-2"></i>Compare
                    </button>
                </div>
                <div class="col-12 date-comparison" id="dateComparison">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="compare_start_date" class="form-label">Compare Start Date</label>
                            <input type="text" class="form-control datepicker" id="compare_start_date" name="compare_start_date">
                        </div>
                        <div class="col-md-4">
                            <label for="compare_end_date" class="form-label">Compare End Date</label>
                            <input type="text" class="form-control datepicker" id="compare_end_date" name="compare_end_date">
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Export Buttons -->
    <div class="export-buttons">
        <button class="btn btn-success me-2" onclick="exportToPDF()">
            <i class="fas fa-file-pdf me-2"></i>Export to PDF
        </button>
        <button class="btn btn-info me-2" onclick="exportToExcel()">
            <i class="fas fa-file-excel me-2"></i>Export to Excel
        </button>
    </div>

    <!-- Charts Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Revenue vs Expenses</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="revenueExpensesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Expense Breakdown</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="expenseBreakdownChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profit & Loss Statement -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Profit & Loss Statement</h5>
            <small class="text-muted">For period: {{ start_date|date:"d M Y" }} to {{ end_date|date:"d M Y" }}</small>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table">
                    <tbody>
                        <tr>
                            <th colspan="3">Revenue</th>
                        </tr>
                        <tr>
                            <td>Product Sales</td>
                            <td class="text-end">BDT {{ revenue_data.product_sales|floatformat:2|intcomma }}</td>
                            <td class="text-end">
                                {% if revenue_data.product_sales_prev %}
                                <span class="comparison-badge {% if revenue_data.product_sales > revenue_data.product_sales_prev %}positive{% else %}negative{% endif %}">
                                    {% if revenue_data.product_sales > revenue_data.product_sales_prev %}↑{% else %}↓{% endif %}
                                    {{ revenue_data.product_sales|subtract:revenue_data.product_sales_prev|floatformat:2|intcomma }}
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>Other Revenue</td>
                            <td class="text-end">BDT {{ revenue_data.manual_revenue|floatformat:2|intcomma }}</td>
                            <td class="text-end">
                                {% if revenue_data.manual_revenue_prev %}
                                <span class="comparison-badge {% if revenue_data.manual_revenue > revenue_data.manual_revenue_prev %}positive{% else %}negative{% endif %}">
                                    {% if revenue_data.manual_revenue > revenue_data.manual_revenue_prev %}↑{% else %}↓{% endif %}
                                    {{ revenue_data.manual_revenue|subtract:revenue_data.manual_revenue_prev|floatformat:2|intcomma }}
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr class="table-primary">
                            <th>Total Revenue</th>
                            <th class="text-end">BDT {{ total_revenue|floatformat:2|intcomma }}</th>
                            <td class="text-end">
                                {% if total_revenue_prev %}
                                <span class="comparison-badge {% if total_revenue > total_revenue_prev %}positive{% else %}negative{% endif %}">
                                    {% if total_revenue > total_revenue_prev %}↑{% else %}↓{% endif %}
                                    {{ total_revenue|subtract:total_revenue_prev|floatformat:2|intcomma }}
                                </span>
                                {% endif %}
                            </td>
                        </tr>

                        <tr>
                            <th colspan="3">Expenses</th>
                        </tr>
                        <tr>
                            <td>Cost of Goods</td>
                            <td class="text-end">BDT {{ expense_data.cost_of_goods|floatformat:2|intcomma }}</td>
                            <td class="text-end">
                                {% if expense_data_prev.cost_of_goods %}
                                <span class="comparison-badge {% if expense_data.cost_of_goods < expense_data_prev.cost_of_goods %}positive{% else %}negative{% endif %}">
                                    {% if expense_data.cost_of_goods < expense_data_prev.cost_of_goods %}↓{% else %}↑{% endif %}
                                    {{ expense_data.cost_of_goods|subtract:expense_data_prev.cost_of_goods|abs|floatformat:2|intcomma }}
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>Shipping Expenses</td>
                            <td class="text-end">BDT {{ expense_data.shipping_expenses|floatformat:2|intcomma }}</td>
                            <td class="text-end">
                                {% if expense_data_prev.shipping_expenses %}
                                <span class="comparison-badge {% if expense_data.shipping_expenses < expense_data_prev.shipping_expenses %}positive{% else %}negative{% endif %}">
                                    {% if expense_data.shipping_expenses < expense_data_prev.shipping_expenses %}↓{% else %}↑{% endif %}
                                    {{ expense_data.shipping_expenses|subtract:expense_data_prev.shipping_expenses|abs|floatformat:2|intcomma }}
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>COD Charges (0.50%)</td>
                            <td class="text-end">BDT {{ expense_data.cod_charges|floatformat:2|intcomma }}</td>
                            <td class="text-end">
                                {% if expense_data_prev.cod_charges %}
                                <span class="comparison-badge {% if expense_data.cod_charges < expense_data_prev.cod_charges %}positive{% else %}negative{% endif %}">
                                    {% if expense_data.cod_charges < expense_data_prev.cod_charges %}↓{% else %}↑{% endif %}
                                    {{ expense_data.cod_charges|subtract:expense_data_prev.cod_charges|abs|floatformat:2|intcomma }}
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% comment %} Dynamically display all expense categories {% endcomment %}
                        {% for key, value in expense_data.items %}
                            {% if key != 'cost_of_goods' and key != 'shipping_expenses' and key != 'cod_charges' %}
                            <tr>
                                <td>{{ key|format_expense_name }}</td>
                                <td class="text-end">BDT {{ value|floatformat:2|intcomma }}</td>
                                <td class="text-end">
                                    {% if expense_data_prev %}
                                        {% with prev_value=expense_data_prev|get_item:key %}
                                            {% if prev_value %}
                                            <span class="comparison-badge {% if value < prev_value %}positive{% else %}negative{% endif %}">
                                                {% if value < prev_value %}↓{% else %}↑{% endif %}
                                                {{ value|subtract:prev_value|abs|floatformat:2|intcomma }}
                                            </span>
                                            {% endif %}
                                        {% endwith %}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endif %}
                        {% endfor %}
<!-- Dynamic expense categories are handled by the for loop above -->
                        <tr class="table-primary">
                            <th>Total Expenses</th>
                            <th class="text-end">BDT {{ total_expenses|floatformat:2|intcomma }}</th>
                            <td class="text-end">
                                {% if total_expenses_prev %}
                                <span class="comparison-badge {% if total_expenses < total_expenses_prev %}positive{% else %}negative{% endif %}">
                                    {% if total_expenses < total_expenses_prev %}↓{% else %}↑{% endif %}
                                    {{ total_expenses|subtract:total_expenses_prev|floatformat:2|intcomma }}
                                </span>
                                {% endif %}
                            </td>
                        </tr>

                        <tr class="table-success">
                            <th>Gross Profit</th>
                            <th class="text-end">BDT {{ gross_profit|floatformat:2|intcomma }}</th>
                            <td class="text-end">
                                {% if gross_profit_prev %}
                                <span class="comparison-badge {% if gross_profit > gross_profit_prev %}positive{% else %}negative{% endif %}">
                                    {% if gross_profit > gross_profit_prev %}↑{% else %}↓{% endif %}
                                    {{ gross_profit|subtract:gross_profit_prev|floatformat:2|intcomma }}
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr class="table-success">
                            <th>Net Profit</th>
                            <th class="text-end">BDT {{ net_profit|floatformat:2|intcomma }}</th>
                            <td class="text-end">
                                {% if net_profit_prev %}
                                <span class="comparison-badge {% if net_profit > net_profit_prev %}positive{% else %}negative{% endif %}">
                                    {% if net_profit > net_profit_prev %}↑{% else %}↓{% endif %}
                                    {{ net_profit|subtract:net_profit_prev|floatformat:2|intcomma }}
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Balance Sheet -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">Balance Sheet</h5>
            <small class="text-muted">As of {{ end_date|date:"d M Y" }}</small>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>Assets</h6>
                    <table class="table">
                        <tbody>
                            {% for asset_name, asset_amount in balance_sheet.assets.items %}
                            <tr>
                                <td>{{ asset_name|title }}</td>
                                <td class="text-end">BDT {{ asset_amount|floatformat:2|intcomma }}</td>
                                <td class="text-end">
                                    {% if balance_sheet_prev and balance_sheet_prev.assets %}
                                        {% with prev_amount=balance_sheet_prev.assets|get_item:asset_name %}
                                            {% if prev_amount is not None %}
                                            <span class="comparison-badge {% if asset_amount > prev_amount %}positive{% else %}negative{% endif %}">
                                                {% if asset_amount > prev_amount %}↑{% else %}↓{% endif %}
                                                {{ asset_amount|subtract:prev_amount|floatformat:2|intcomma }}
                                            </span>
                                            {% endif %}
                                        {% endwith %}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            <tr class="table-primary">
                                <th>Total Assets</th>
                                <th class="text-end">BDT {{ total_assets|floatformat:2|intcomma }}</th>
                                <td class="text-end">
                                    {% if total_assets_prev %}
                                    <span class="comparison-badge {% if total_assets > total_assets_prev %}positive{% else %}negative{% endif %}">
                                        {% if total_assets > total_assets_prev %}↑{% else %}↓{% endif %}
                                        {{ total_assets|subtract:total_assets_prev|floatformat:2|intcomma }}
                                    </span>
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>Liabilities & Equity</h6>
                    <table class="table">
                        <tbody>
                            {% for liability_name, liability_amount in balance_sheet.liabilities.items %}
                            <tr>
                                <td>{{ liability_name|title }}</td>
                                <td class="text-end">BDT {{ liability_amount|floatformat:2|intcomma }}</td>
                                <td class="text-end">
                                    {% if balance_sheet_prev and balance_sheet_prev.liabilities %}
                                        {% with prev_amount=balance_sheet_prev.liabilities|get_item:liability_name %}
                                            {% if prev_amount is not None %}
                                            <span class="comparison-badge {% if liability_amount < prev_amount %}positive{% else %}negative{% endif %}">
                                                {% if liability_amount < prev_amount %}↓{% else %}↑{% endif %}
                                                {{ liability_amount|subtract:prev_amount|floatformat:2|intcomma }}
                                            </span>
                                            {% endif %}
                                        {% endwith %}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            <tr class="table-primary">
                                <th>Total Liabilities</th>
                                <th class="text-end">BDT {{ total_liabilities|floatformat:2|intcomma }}</th>
                                <td class="text-end">
                                    {% if total_liabilities_prev %}
                                    <span class="comparison-badge {% if total_liabilities < total_liabilities_prev %}positive{% else %}negative{% endif %}">
                                        {% if total_liabilities < total_liabilities_prev %}↓{% else %}↑{% endif %}
                                        {{ total_liabilities|subtract:total_liabilities_prev|floatformat:2|intcomma }}
                                    </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% for equity_name, equity_amount in balance_sheet.equity.items %}
                            <tr>
                                <td>{{ equity_name|title }}</td>
                                <td class="text-end">BDT {{ equity_amount|floatformat:2|intcomma }}</td>
                                <td class="text-end">
                                    {% if balance_sheet_prev and balance_sheet_prev.equity %}
                                        {% with prev_amount=balance_sheet_prev.equity|get_item:equity_name %}
                                            {% if prev_amount is not None %}
                                            <span class="comparison-badge {% if equity_amount > prev_amount %}positive{% else %}negative{% endif %}">
                                                {% if equity_amount > prev_amount %}↑{% else %}↓{% endif %}
                                                {{ equity_amount|subtract:prev_amount|floatformat:2|intcomma }}
                                            </span>
                                            {% endif %}
                                        {% endwith %}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            <tr class="table-primary">
                                <th>Total Equity</th>
                                <th class="text-end">BDT {{ total_equity|floatformat:2|intcomma }}</th>
                                <td class="text-end">
                                    {% if total_equity_prev %}
                                    <span class="comparison-badge {% if total_equity > total_equity_prev %}positive{% else %}negative{% endif %}">
                                        {% if total_equity > total_equity_prev %}↑{% else %}↓{% endif %}
                                        {{ total_equity|subtract:total_equity_prev|floatformat:2|intcomma }}
                                    </span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr class="table-success">
                                <th>Total Liabilities & Equity</th>
                                <th class="text-end">BDT {{ total_liabilities|add:total_equity|floatformat:2|intcomma }}</th>
                                <td class="text-end">
                                    {% if total_liabilities_prev and total_equity_prev %}
                                    <span class="comparison-badge {% if total_liabilities|add:total_equity > total_liabilities_prev|add:total_equity_prev %}positive{% else %}negative{% endif %}">
                                        {% if total_liabilities|add:total_equity > total_liabilities_prev|add:total_equity_prev %}↑{% else %}↓{% endif %}
                                        {{ total_liabilities|add:total_equity|subtract:total_liabilities_prev|add:total_equity_prev|floatformat:2|intcomma }}
                                    </span>
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Navigation Buttons -->
<div class="nav-buttons">
    <a href="{% url 'accounts:journal_entries' %}" class="btn btn-primary" title="Journal Entries">
        <i class="fas fa-book"></i>
    </a>
    <a href="{% url 'accounts:receivables' %}" class="btn btn-info" title="Receivables">
        <i class="fas fa-money-bill-wave"></i>
    </a>
    <a href="{% url 'accounts:payables' %}" class="btn btn-warning" title="Payables">
        <i class="fas fa-file-invoice-dollar"></i>
    </a>
    <a href="{% url 'accounts:expenses' %}" class="btn btn-danger" title="Expenses">
        <i class="fas fa-receipt"></i>
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
    // Initialize date pickers
    flatpickr(".datepicker", {
        dateFormat: "d/m/Y",
        allowInput: true
    });

    // Initialize charts
    const revenueExpensesCtx = document.getElementById('revenueExpensesChart').getContext('2d');
    new Chart(revenueExpensesCtx, {
        type: 'bar',
        data: {
            labels: ['Revenue', 'Expenses'],
            datasets: [{
                label: 'Current Period',
                data: [{{ total_revenue }}, {{ total_expenses }}],
                backgroundColor: ['rgba(40, 167, 69, 0.5)', 'rgba(220, 53, 69, 0.5)'],
                borderColor: ['rgb(40, 167, 69)', 'rgb(220, 53, 69)'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    const expenseBreakdownCtx = document.getElementById('expenseBreakdownChart').getContext('2d');
    new Chart(expenseBreakdownCtx, {
        type: 'pie',
        data: {
            labels: [
                {% for expense_name, expense_amount in expense_data.items %}
                '{{ expense_name|title }}',
                {% endfor %}
            ],
            datasets: [{
                data: [
                    {% for expense_amount in expense_data.values %}
                    {{ expense_amount }},
                    {% endfor %}
                ],
                backgroundColor: [
                    'rgba(255, 99, 132, 0.5)',
                    'rgba(54, 162, 235, 0.5)',
                    'rgba(255, 206, 86, 0.5)',
                    'rgba(75, 192, 192, 0.5)',
                    'rgba(153, 102, 255, 0.5)',
                    'rgba(255, 159, 64, 0.5)',
                    'rgba(199, 199, 199, 0.5)',
                    'rgba(83, 102, 255, 0.5)'
                ],
                borderColor: [
                    'rgb(255, 99, 132)',
                    'rgb(54, 162, 235)',
                    'rgb(255, 206, 86)',
                    'rgb(75, 192, 192)',
                    'rgb(153, 102, 255)',
                    'rgb(255, 159, 64)',
                    'rgb(199, 199, 199)',
                    'rgb(83, 102, 255)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Export to PDF
    function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Add title
        doc.setFontSize(20);
        doc.text('Financial Reports', 20, 20);
        
        // Add date range
        doc.setFontSize(12);
        doc.text(`Period: ${document.getElementById('start_date').value} to ${document.getElementById('end_date').value}`, 20, 30);
        
        // Add content
        let y = 50;
        const tables = document.querySelectorAll('.table');
        tables.forEach(table => {
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('th, td');
                let x = 20;
                cells.forEach(cell => {
                    doc.text(cell.textContent, x, y);
                    x += 50;
                });
                y += 10;
            });
            y += 20;
        });
        
        doc.save('financial_reports.pdf');
    }

    // Export to Excel
    function exportToExcel() {
        try {
            const wb = XLSX.utils.book_new();
            
            // Helper function to clean table data
            function cleanTableData(table) {
                const rows = Array.from(table.querySelectorAll('tr'));
                return rows.map(row => {
                    const cells = Array.from(row.querySelectorAll('th, td'));
                    return cells.map(cell => {
                        // Remove BDT prefix and commas from numbers
                        let text = cell.textContent.trim();
                        text = text.replace('BDT', '').replace(/,/g, '').trim();
                        // Try to convert to number if possible
                        const num = parseFloat(text);
                        return isNaN(num) ? text : num;
                    });
                });
            }

            // Add P&L Statement
            const plTable = document.querySelector('.card:nth-child(3) .table');
            if (plTable) {
                const plData = cleanTableData(plTable);
                const plSheet = XLSX.utils.aoa_to_sheet(plData);
                XLSX.utils.book_append_sheet(wb, plSheet, 'Profit & Loss');
            }
            
            // Add Balance Sheet
            const bsTable = document.querySelector('.card:nth-child(4) .table');
            if (bsTable) {
                const bsData = cleanTableData(bsTable);
                const bsSheet = XLSX.utils.aoa_to_sheet(bsData);
                XLSX.utils.book_append_sheet(wb, bsSheet, 'Balance Sheet');
            }
            
            // Add date range to filename
            const startDate = document.getElementById('start_date').value.replace(/\//g, '-');
            const endDate = document.getElementById('end_date').value.replace(/\//g, '-');
            const filename = `financial_reports_${startDate}_to_${endDate}.xlsx`;
            
            // Save the file
            XLSX.writeFile(wb, filename);
        } catch (error) {
            console.error('Error exporting to Excel:', error);
            alert('There was an error exporting to Excel. Please try again.');
        }
    }

    // Comparison toggle
    document.getElementById('compareToggle').addEventListener('click', function() {
        const comparisonDiv = document.getElementById('dateComparison');
        comparisonDiv.classList.toggle('show');
    });
</script>
{% endblock %} 